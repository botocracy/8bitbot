From 3b60ce5ba48be9b9ce5dbccd1ee9890576ca0f64 Mon Sep 17 00:00:00 2001
From: Marquise Stein <botocratic@gmail.com>
Date: Wed, 4 Nov 2020 08:22:52 -0800
Subject: [PATCH] Replace crypto builtins with npm packages

Fixes error with rollup:

    Uncaught (in promise) TypeError: fs.createHmac is not a function
---
 lib/hdkey.js | 10 ++++++----
 package.json |  2 ++
 2 files changed, 8 insertions(+), 4 deletions(-)

diff --git a/lib/hdkey.js b/lib/hdkey.js
index c7dc805..e70aec2 100644
--- a/lib/hdkey.js
+++ b/lib/hdkey.js
@@ -1,5 +1,7 @@
 var assert = require('assert')
 var Buffer = require('safe-buffer').Buffer
+var createHash = require('create-hash')
+var createHmac = require('create-hmac')
 var crypto = require('crypto')
 var bs58check = require('bs58check')
 var secp256k1 = require('secp256k1')
@@ -115,7 +117,7 @@ HDKey.prototype.deriveChild = function (index) {
     data = Buffer.concat([this.publicKey, indexBuffer])
   }
 
-  var I = crypto.createHmac('sha512', this.chainCode).update(data).digest()
+  var I = createHmac('sha512', this.chainCode).update(data).digest()
   var IL = I.slice(0, 32)
   var IR = I.slice(32)
 
@@ -178,7 +180,7 @@ HDKey.prototype.toJSON = function () {
 }
 
 HDKey.fromMasterSeed = function (seedBuffer, versions) {
-  var I = crypto.createHmac('sha512', MASTER_SECRET).update(seedBuffer).digest()
+  var I = createHmac('sha512', MASTER_SECRET).update(seedBuffer).digest()
   var IL = I.slice(0, 32)
   var IR = I.slice(32)
 
@@ -238,8 +240,8 @@ function serialize (hdkey, version, key) {
 }
 
 function hash160 (buf) {
-  var sha = crypto.createHash('sha256').update(buf).digest()
-  return crypto.createHash('ripemd160').update(sha).digest()
+  var sha = createHash('sha256').update(buf).digest()
+  return createHash('ripemd160').update(sha).digest()
 }
 
 HDKey.HARDENED_OFFSET = HARDENED_OFFSET
diff --git a/package.json b/package.json
index 5664628..21802c0 100644
--- a/package.json
+++ b/package.json
@@ -35,6 +35,8 @@
   },
   "dependencies": {
     "bs58check": "^2.1.2",
+    "create-hash": "^1.2.0",
+    "create-hmac": "^1.1.7",
     "safe-buffer": "^5.1.1",
     "secp256k1": "^4.0.0"
   },
-- 
2.17.1

